---
// Prefer process.env so Cloudflare Pages build-time env vars work even if Vite doesn't
// surface them on `import.meta.env` in this context.
// Default to a known GA4 Measurement ID so the static site always contains the tag.
// This ID is not secret; it will be visible in page source regardless.
const DEFAULT_GA_ID = 'G-7B78J3N2SD';
const gaId =
  process.env.PUBLIC_GA_MEASUREMENT_ID ??
  import.meta.env.PUBLIC_GA_MEASUREMENT_ID ??
  DEFAULT_GA_ID;
const isProdBuild =
  import.meta.env.PROD || process.env.CF_PAGES === '1' || process.env.NODE_ENV === 'production';
const enabled = isProdBuild && typeof gaId === 'string' && gaId.length > 0;

// Keep the inline JS opaque to Astro/Prettier parsers.
const inlineConfigJs = enabled
  ? `window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', ${JSON.stringify(gaId)}, {
  allow_google_signals: false,
  allow_ad_personalization_signals: false,
});`
  : '';
---

{
  enabled ? (
    <>
      <script async src={`https://www.googletagmanager.com/gtag/js?id=${gaId}`} />
      <script is:inline set:html={inlineConfigJs} />
    </>
  ) : null
}
