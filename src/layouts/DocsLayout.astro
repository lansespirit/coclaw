---
import BaseLayout from './BaseLayout.astro';
import { getCollection } from 'astro:content';
import RelatedLinks from '../components/RelatedLinks.astro';
import { buildWeightedTokens, topRelated } from '../lib/related';

interface Props {
  frontmatter: {
    title: string;
    description: string;
    publishDate: Date | string | number;
    lastUpdated: Date | string | number;
    author?: string;
    category: string;
    difficulty?: string;
    estimatedTime?: string;
  };
}

const { frontmatter } = Astro.props;
// MDX `layout:` frontmatter values are not guaranteed to be `Date` objects.
// Coerce them so build-time rendering doesn't crash.
const publishDate =
  frontmatter.publishDate instanceof Date
    ? frontmatter.publishDate
    : new Date(frontmatter.publishDate);
const lastUpdated =
  frontmatter.lastUpdated instanceof Date
    ? frontmatter.lastUpdated
    : new Date(frontmatter.lastUpdated);
const hasValidPublishDate = !Number.isNaN(publishDate.getTime());
const hasValidLastUpdated = !Number.isNaN(lastUpdated.getTime());

const pathname = Astro.url?.pathname ?? '';
const isGettingStarted = pathname.startsWith('/getting-started/');
const docSlug = isGettingStarted
  ? pathname.replace('/getting-started/', '').replace(/\/+$/, '')
  : null;

let relatedItems: Array<{ href: string; title: string; description?: string; badge?: string }> = [];
if (docSlug) {
  const allDocs = await getCollection('getting-started', ({ data }) => !data.draft);
  const current = allDocs.find((d) => d.slug === docSlug);

  if (current) {
    const seedTokens = buildWeightedTokens([
      { text: current.data.title, weight: 3 },
      { text: current.data.description, weight: 2 },
      { text: current.data.keywords ?? [], weight: 2 },
      { text: current.data.category, weight: 1 },
    ]);

    const relatedDocs = topRelated({
      seed: { id: current.slug, tokens: seedTokens },
      candidates: allDocs.map((d) => ({
        id: d.slug,
        tokens: buildWeightedTokens([
          { text: d.data.title, weight: 3 },
          { text: d.data.description, weight: 2 },
          { text: d.data.keywords ?? [], weight: 2 },
          { text: d.data.category, weight: 1 },
        ]),
        item: d,
      })),
      limit: 3,
    }).map(({ item }) => ({
      href: `/getting-started/${item.slug}`,
      title: item.data.title,
      description: item.data.description,
      badge: 'Start',
    }));

    const allGuides = await getCollection('guides', ({ data }) => !data.draft);
    const relatedGuides = topRelated({
      seed: { id: current.slug, tokens: seedTokens },
      candidates: allGuides.map((g) => ({
        id: g.slug,
        tokens: buildWeightedTokens([
          { text: g.data.title, weight: 3 },
          { text: g.data.description, weight: 2 },
          { text: g.data.keywords ?? [], weight: 2 },
          { text: g.data.category, weight: 1 },
          { text: g.data.platforms ?? [], weight: 1 },
        ]),
        item: g,
      })),
      limit: 3,
    }).map(({ item }) => ({
      href: `/guides/${item.slug}`,
      title: item.data.title,
      description: item.data.description,
      badge: 'Guide',
    }));

    const allSolutions = await getCollection(
      'troubleshooting',
      ({ data }) => !data.draft && data.kind === 'solution'
    );
    const relatedSolutions = topRelated({
      seed: { id: current.slug, tokens: seedTokens },
      candidates: allSolutions.map((s) => ({
        id: s.slug,
        tokens: buildWeightedTokens([
          { text: s.data.title, weight: 3 },
          { text: s.data.description, weight: 2 },
          { text: s.data.keywords ?? [], weight: 2 },
          { text: s.data.component, weight: 1 },
          { text: s.data.errorSignatures ?? [], weight: 1 },
        ]),
        item: s,
      })),
      limit: 2,
    }).map(({ item }) => ({
      href: `/troubleshooting/${item.slug}`,
      title: item.data.title,
      description: item.data.description,
      badge: 'Fix',
    }));

    relatedItems = [...relatedGuides, ...relatedDocs, ...relatedSolutions].slice(0, 6);
  }
}
---

<BaseLayout title={frontmatter.title} description={frontmatter.description}>
  <div class="container mx-auto px-4 py-8 max-w-4xl">
    <article class="c-content prose prose-lg">
      <header class="mb-8">
        <div class="flex gap-2 mb-4">
          <span
            class="px-3 py-1 rounded-full text-sm border border-primary/20 bg-primary/10 text-primary-700 dark:text-primary-300"
          >
            {frontmatter.category}
          </span>
          {
            frontmatter.difficulty && (
              <span class="px-3 py-1 rounded-full text-sm border border-success/20 bg-success/10 text-success-700 dark:text-success-300">
                {frontmatter.difficulty}
              </span>
            )
          }
          {
            frontmatter.estimatedTime && (
              <span class="px-3 py-1 rounded-full text-sm border border-secondary/20 bg-secondary/10 text-secondary-700 dark:text-secondary-300">
                {frontmatter.estimatedTime}
              </span>
            )
          }
        </div>
        <h1 class="text-4xl font-bold mb-4">{frontmatter.title}</h1>
        <p class="text-xl text-default-700 dark:text-default-500 mb-4">{frontmatter.description}</p>
        <div class="flex gap-4 text-sm text-default-600 dark:text-default-500">
          <span>By {frontmatter.author || 'CoClaw Team'}</span>
          <span>•</span>
          <time datetime={hasValidPublishDate ? publishDate.toISOString() : undefined}>
            {
              hasValidPublishDate
                ? publishDate.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                  })
                : 'Unknown date'
            }
          </time>
          {
            hasValidLastUpdated &&
              hasValidPublishDate &&
              lastUpdated.getTime() !== publishDate.getTime() && (
                <>
                  <span>•</span>
                  <span>
                    Updated{' '}
                    {lastUpdated.toLocaleDateString('en-US', {
                      year: 'numeric',
                      month: 'long',
                      day: 'numeric',
                    })}
                  </span>
                </>
              )
          }
        </div>
      </header>
      <slot />
    </article>

    <RelatedLinks title="Related Resources" items={relatedItems} />
  </div>
</BaseLayout>
