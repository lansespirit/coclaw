---
import BaseLayout from './BaseLayout.astro';

interface Props {
  frontmatter: {
    title: string;
    description: string;
    publishDate: Date | string | number;
    lastUpdated: Date | string | number;

    kind?: 'solution' | 'case';
    component?: string;
    severity?: 'low' | 'medium' | 'high' | 'critical';
    os?: string[];
    channel?: string[];
    errorSignatures?: string[];
    affectedVersions?: string[];
    author?: string;
  };
}

const { frontmatter } = Astro.props;

const publishDate =
  frontmatter.publishDate instanceof Date
    ? frontmatter.publishDate
    : new Date(frontmatter.publishDate);
const lastUpdated =
  frontmatter.lastUpdated instanceof Date
    ? frontmatter.lastUpdated
    : new Date(frontmatter.lastUpdated);
const hasValidPublishDate = !Number.isNaN(publishDate.getTime());
const hasValidLastUpdated = !Number.isNaN(lastUpdated.getTime());

const kind = frontmatter.kind ?? 'solution';
const channels = (frontmatter.channel ?? []).filter(Boolean);
const os = (frontmatter.os ?? []).filter(Boolean);
const component = frontmatter.component?.trim();
const severity = frontmatter.severity?.trim();
const errorSignatures = (frontmatter.errorSignatures ?? []).filter(Boolean);
---

<BaseLayout title={frontmatter.title} description={frontmatter.description}>
  <div class="container mx-auto px-4 py-8 max-w-4xl">
    <!-- Pagefind filters/meta -->
    <div class="hidden" data-pagefind-filter="type:troubleshooting"></div>
    <div class="hidden" data-pagefind-filter={`kind:${kind}`}></div>
    {component ? <div class="hidden" data-pagefind-filter={`component:${component}`} /> : null}
    {severity ? <div class="hidden" data-pagefind-filter={`severity:${severity}`} /> : null}
    {channels.map((c) => <div class="hidden" data-pagefind-filter={`channel:${c}`} />)}
    {os.map((o) => <div class="hidden" data-pagefind-filter={`os:${o}`} />)}
    {
      errorSignatures.map((s) => (
        <div class="hidden" data-pagefind-meta="error_signature">
          {s}
        </div>
      ))
    }

    <article class="c-content prose prose-lg">
      <header class="mb-8">
        <div class="flex flex-wrap gap-2 mb-4">
          <span
            class={`px-3 py-1 rounded-full text-sm font-semibold ${
              kind === 'solution'
                ? 'border border-success/20 bg-success/10 text-success-700 dark:text-success-300'
                : 'border border-divider bg-content2/50 text-default-700 dark:text-default-300'
            }`}
          >
            {kind}
          </span>

          {
            component ? (
              <span class="px-3 py-1 rounded-full text-sm border border-primary/20 bg-primary/10 text-primary-700 dark:text-primary-300">
                {component}
              </span>
            ) : null
          }

          {
            severity ? (
              <span class="px-3 py-1 rounded-full text-sm border border-danger/20 bg-danger/10 text-danger-700 dark:text-danger-300">
                {severity}
              </span>
            ) : null
          }

          {
            os.map((o) => (
              <span class="px-3 py-1 rounded-full text-sm border border-secondary/20 bg-secondary/10 text-secondary-700 dark:text-secondary-300">
                {o}
              </span>
            ))
          }

          {
            channels.map((c) => (
              <span class="px-3 py-1 rounded-full text-sm border border-warning/20 bg-warning/10 text-warning-700 dark:text-warning-300">
                {c}
              </span>
            ))
          }
        </div>

        <h1 class="text-4xl font-bold mb-4">{frontmatter.title}</h1>
        <p class="text-xl text-default-700 dark:text-default-500 mb-4">{frontmatter.description}</p>

        <div class="flex flex-wrap gap-4 text-sm text-default-600 dark:text-default-500">
          <span>By {frontmatter.author || 'CoClaw Team'}</span>
          <span>•</span>
          <time datetime={hasValidPublishDate ? publishDate.toISOString() : undefined}>
            {
              hasValidPublishDate
                ? publishDate.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                  })
                : 'Unknown date'
            }
          </time>
          {
            hasValidLastUpdated &&
              hasValidPublishDate &&
              lastUpdated.getTime() !== publishDate.getTime() && (
                <>
                  <span>•</span>
                  <span>
                    Updated{' '}
                    {lastUpdated.toLocaleDateString('en-US', {
                      year: 'numeric',
                      month: 'long',
                      day: 'numeric',
                    })}
                  </span>
                </>
              )
          }
        </div>
      </header>

      {
        errorSignatures.length ? (
          <div class="hidden">Error signatures: {errorSignatures.join(' | ')}</div>
        ) : null
      }

      <slot />
    </article>

    <div class="mt-10 border-t border-divider pt-6">
      <div class="flex flex-wrap items-center justify-between gap-3">
        <div class="text-sm text-default-600">
          Want to explore more? Browse{' '}
          <a class="text-primary hover:underline" href="/troubleshooting/solutions">all solutions</a
          >{' '}
          or ask in the{' '}
          <a
            class="text-primary hover:underline"
            href="https://forum.coclaw.com"
            target="_blank"
            rel="noopener noreferrer"
          >
            Community Forum
          </a>
          .
        </div>
        <a
          class="inline-flex items-center rounded-full bg-content1 border border-divider px-4 py-2 text-sm font-semibold hover:bg-content2 transition-colors"
          href="https://github.com/openclaw/openclaw/issues/new/choose"
          target="_blank"
          rel="noopener noreferrer"
        >
          Report a problem
        </a>
      </div>
    </div>
  </div>
</BaseLayout>
