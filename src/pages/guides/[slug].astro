---
import { getCollection } from 'astro:content';
import type { GetStaticPaths } from 'astro';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Section from '../../components/layout/Section.astro';
import { GuideStepsAccordion } from '../../components/GuideStepsAccordion';
import { Button, Chip } from '@heroui/react';

export const getStaticPaths = (async () => {
  const entries = await getCollection('guides', ({ data }) => !data.draft);
  return entries.map((entry) => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}) satisfies GetStaticPaths;

const { entry } = Astro.props;
const { Content } = await entry.render();

const { title, difficulty, platforms, time, description, steps } = entry.data;
const platformLabel = platforms.join(' / ');
const hasBody = Boolean(entry.body?.trim());

const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const structuredData = {
  '@context': 'https://schema.org',
  '@type': 'HowTo',
  name: title,
  description,
  step: steps.map((s) => ({ '@type': 'HowToStep', name: s.title, text: s.content })),
  mainEntityOfPage: canonicalURL.toString(),
};
---

<BaseLayout title={`${title} | CoClaw Guides`} description={description} type="article">
  <script type="application/ld+json" slot="head" set:html={JSON.stringify(structuredData)} />
  <div class="bg-background min-h-screen pt-32 pb-24">
    <Section containerClass="max-w-4xl mx-auto px-6">
      <div class="mb-12">
        <div class="flex flex-wrap items-center gap-4 mb-6">
          <Chip color="success" variant="flat" size="sm" className="font-bold">{difficulty}</Chip>
          <Chip variant="bordered" size="sm">{platformLabel}</Chip>
          <span class="text-default-500 text-sm font-medium">Estimated time: {time}</span>
        </div>
        <h1 class="text-4xl md:text-6xl font-black tracking-tighter mb-6">{title}</h1>
        <p class="text-xl text-default-600 leading-relaxed max-w-2xl">
          {description}
        </p>
      </div>

      <div class="m-card-surface overflow-hidden">
        <div class="p-8 border-b border-divider bg-content1/50">
          <h3 class="font-bold text-lg">Implementation Steps</h3>
        </div>
        <GuideStepsAccordion steps={steps} client:load />
      </div>

      {
        hasBody ? (
          <article class="mt-16 c-content prose prose-lg prose-primary max-w-none">
            <Content />
          </article>
        ) : null
      }

      <div
        class="mt-16 flex flex-wrap gap-4 items-center justify-between p-8 rounded-3xl bg-primary/5 border border-primary/10"
      >
        <div>
          <h4 class="text-xl font-bold mb-2">Need live assistance?</h4>
          <p class="text-default-600">Ask in the community forum or Discord support channels.</p>
        </div>
        <Button
          as="a"
          href="https://forum.coclaw.com"
          target="_blank"
          rel="noopener noreferrer"
          color="primary"
          radius="full"
          className="font-bold px-8"
        >
          Get Support
        </Button>
      </div>
    </Section>
  </div>
</BaseLayout>
