---
import { getCollection } from 'astro:content';
import type { GetStaticPaths } from 'astro';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Section from '../../components/layout/Section.astro';
import { GuideStepsAccordion } from '../../components/GuideStepsAccordion';
import RelatedLinks from '../../components/RelatedLinks.astro';
import { buildWeightedTokens, topRelated } from '../../lib/related';
import { Button, Chip } from '@heroui/react';

export const getStaticPaths = (async () => {
  const entries = await getCollection('guides', ({ data }) => !data.draft);
  return entries.map((entry) => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}) satisfies GetStaticPaths;

const { entry } = Astro.props;
const { Content } = await entry.render();

const { title, difficulty, platforms, time, description, steps } = entry.data;
const platformLabel = platforms.join(' / ');
const hasBody = Boolean(entry.body?.trim());

const allGuides = await getCollection('guides', ({ data }) => !data.draft);
const allSolutions = await getCollection(
  'troubleshooting',
  ({ data }) => !data.draft && data.kind === 'solution'
);
const allGettingStarted = await getCollection('getting-started', ({ data }) => !data.draft);

const seedTokens = buildWeightedTokens([
  { text: title, weight: 3 },
  { text: description, weight: 2 },
  { text: entry.data.keywords ?? [], weight: 2 },
  { text: entry.data.category, weight: 1 },
  { text: entry.data.platforms ?? [], weight: 1 },
]);

const relatedGuides = topRelated({
  seed: { id: entry.slug, tokens: seedTokens },
  candidates: allGuides.map((g) => ({
    id: g.slug,
    tokens: buildWeightedTokens([
      { text: g.data.title, weight: 3 },
      { text: g.data.description, weight: 2 },
      { text: g.data.keywords ?? [], weight: 2 },
      { text: g.data.category, weight: 1 },
      { text: g.data.platforms ?? [], weight: 1 },
    ]),
    item: g,
  })),
  limit: 3,
}).map(({ item }) => ({
  href: `/guides/${item.slug}`,
  title: item.data.title,
  description: item.data.description,
  badge: 'Guide',
}));

const relatedSolutions = topRelated({
  seed: { id: entry.slug, tokens: seedTokens },
  candidates: allSolutions.map((s) => ({
    id: s.slug,
    tokens: buildWeightedTokens([
      { text: s.data.title, weight: 3 },
      { text: s.data.description, weight: 2 },
      { text: s.data.keywords ?? [], weight: 2 },
      { text: s.data.component, weight: 1 },
      { text: s.data.os ?? [], weight: 1 },
      { text: s.data.channel ?? [], weight: 1 },
      { text: s.data.errorSignatures ?? [], weight: 1 },
    ]),
    item: s,
  })),
  limit: 3,
}).map(({ item }) => ({
  href: `/troubleshooting/${item.slug}`,
  title: item.data.title,
  description: item.data.description,
  badge: 'Fix',
}));

const relatedGettingStarted = topRelated({
  seed: { id: entry.slug, tokens: seedTokens },
  candidates: allGettingStarted.map((d) => ({
    id: d.slug,
    tokens: buildWeightedTokens([
      { text: d.data.title, weight: 3 },
      { text: d.data.description, weight: 2 },
      { text: d.data.keywords ?? [], weight: 2 },
      { text: d.data.category, weight: 1 },
    ]),
    item: d,
  })),
  limit: 2,
}).map(({ item }) => ({
  href: `/getting-started/${item.slug}`,
  title: item.data.title,
  description: item.data.description,
  badge: 'Start',
}));

const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const structuredData = {
  '@context': 'https://schema.org',
  '@type': 'HowTo',
  name: title,
  description,
  step: steps.map((s) => ({ '@type': 'HowToStep', name: s.title, text: s.content })),
  mainEntityOfPage: canonicalURL.toString(),
};
---

<BaseLayout title={`${title} | CoClaw Guides`} description={description} type="article">
  <script type="application/ld+json" slot="head" set:html={JSON.stringify(structuredData)} />
  <div class="bg-background min-h-screen pt-32 pb-24">
    <Section containerClass="max-w-4xl mx-auto px-6">
      <div class="mb-12">
        <div class="flex flex-wrap items-center gap-4 mb-6">
          <Chip color="success" variant="flat" size="sm" className="font-bold">{difficulty}</Chip>
          <Chip variant="bordered" size="sm">{platformLabel}</Chip>
          <span class="text-default-500 text-sm font-medium">Estimated time: {time}</span>
        </div>
        <h1 class="text-4xl md:text-6xl font-black tracking-tighter mb-6">{title}</h1>
        <p class="text-xl text-default-600 leading-relaxed max-w-2xl">
          {description}
        </p>
      </div>

      <div class="m-card-surface overflow-hidden">
        <div class="p-8 border-b border-divider bg-content1/50">
          <h3 class="font-bold text-lg">Implementation Steps</h3>
        </div>
        <GuideStepsAccordion steps={steps} client:load />
      </div>

      {
        hasBody ? (
          <article class="mt-16 c-content prose prose-lg prose-primary max-w-none">
            <Content />
          </article>
        ) : null
      }

      <RelatedLinks
        title="Related Resources"
        items={[...relatedGuides, ...relatedSolutions, ...relatedGettingStarted]}
      />

      <div
        class="mt-16 flex flex-wrap gap-4 items-center justify-between p-8 rounded-3xl bg-primary/5 border border-primary/10"
      >
        <div>
          <h4 class="text-xl font-bold mb-2">Need live assistance?</h4>
          <p class="text-default-600">Ask in the community forum or Discord support channels.</p>
        </div>
        <Button
          as="a"
          href="https://forum.coclaw.com"
          target="_blank"
          rel="noopener noreferrer"
          color="primary"
          radius="full"
          className="font-bold px-8"
        >
          Get Support
        </Button>
      </div>
    </Section>
  </div>
</BaseLayout>
