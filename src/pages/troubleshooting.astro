---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import Section from '../components/layout/Section.astro';
import { TroubleshootingSearch } from '../components/troubleshooting/TroubleshootingSearch';

import {
  IconChat,
  IconChevronRight,
  IconCodeBracket,
  IconCog,
  IconDesktop,
  IconDiscord,
  IconGithub,
  IconLockClosed,
  IconWarning,
} from '../components/icons';

const troubleshootingEntries = await getCollection('troubleshooting', ({ data }) => !data.draft);
const solutions = troubleshootingEntries.filter((e) => e.data.kind === 'solution');

const featuredSolutions = [...solutions]
  .sort((a, b) => b.data.lastUpdated.getTime() - a.data.lastUpdated.getTime())
  .slice(0, 8)
  .map((entry) => ({
    title: entry.data.title,
    description: entry.data.description,
    href: `/troubleshooting/${entry.slug}`,
  }));

const channels = Array.from(
  new Set(
    solutions
      .flatMap((e) => e.data.channel ?? [])
      .map((v) => v.trim())
      .filter(Boolean)
  )
).sort((a, b) => a.localeCompare(b));
const os = Array.from(
  new Set(
    solutions
      .flatMap((e) => e.data.os ?? [])
      .map((v) => v.trim())
      .filter(Boolean)
  )
).sort((a, b) => a.localeCompare(b));
const components = Array.from(
  new Set(
    solutions
      .map((e) => e.data.component ?? '')
      .map((v) => v.trim())
      .filter(Boolean)
  )
).sort((a, b) => a.localeCompare(b));
const severities = Array.from(
  new Set(
    solutions
      .map((e) => e.data.severity ?? '')
      .map((v) => v.trim())
      .filter(Boolean)
  )
).sort((a, b) => a.localeCompare(b));
---

<BaseLayout
  title="Troubleshooting - OpenClaw Solutions"
  description="Find step-by-step solutions to common OpenClaw problems. Search our troubleshooting database for installation errors, channel integration issues, and configuration fixes."
  keywords="OpenClaw troubleshooting, OpenClaw errors, OpenClaw issues, OpenClaw problems, OpenClaw help, OpenClaw support"
>
  <div class="bg-background min-h-screen overflow-x-hidden relative">
    <!-- Hero + Search -->
    <Section py="pt-24 pb-14" containerClass="text-center">
      <h1
        class="text-5xl md:text-6xl font-bold mb-6 bg-gradient-to-br from-foreground to-foreground/70 bg-clip-text text-transparent"
      >
        Troubleshooting Hub
      </h1>
      <p class="text-xl text-default-800 dark:text-default-600 max-w-3xl mx-auto">
        Find solutions to common OpenClaw issues and get back up and running quickly
      </p>

      <div class="mt-10 max-w-4xl mx-auto text-left">
        <TroubleshootingSearch
          channels={channels}
          os={os}
          components={components}
          severities={severities}
          client:load
        />
        <p class="text-sm text-default-600 mt-4 text-center">
          Prefer browsing? See{' '}
          <a class="text-primary hover:underline font-medium" href="/troubleshooting/solutions">
            all solutions
          </a>
          .
        </p>
      </div>
    </Section>

    <!-- Solution Categories -->
    <Section py="pt-10 pb-16">
      <h2 class="text-3xl md:text-4xl font-bold mb-8 text-center">Browse Solutions by Category</h2>
      <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6">
        <!-- Install & Setup -->
        <a
          href="/troubleshooting/solutions?component=install"
          class="group relative overflow-hidden rounded-2xl border border-divider bg-content1 p-6 hover:border-primary/50 transition-all duration-300 hover:shadow-lg hover:shadow-primary/10 hover:-translate-y-1"
        >
          <div class="mb-4">
            <div
              class="w-12 h-12 rounded-xl bg-gradient-to-br from-danger-500 to-warning-600 flex items-center justify-center"
            >
              <IconWarning className="w-6 h-6 text-white" aria-hidden="true" />
            </div>
          </div>
          <h3 class="text-xl font-bold mb-2 group-hover:text-primary transition-colors">
            Install & Setup
          </h3>
          <p class="text-default-700 dark:text-default-500 text-sm mb-4">
            Node version, PATH, permission errors, CLI not found
          </p>
          <div class="flex items-center text-primary text-sm font-medium">
            <span>View solutions</span>
            <IconChevronRight
              className="w-4 h-4 ml-1 group-hover:translate-x-1 transition-transform"
              aria-hidden="true"
            />
          </div>
        </a>

        <!-- Channels -->
        <a
          href="/troubleshooting/solutions?component=channel"
          class="group relative overflow-hidden rounded-2xl border border-divider bg-content1 p-6 hover:border-primary/50 transition-all duration-300 hover:shadow-lg hover:shadow-primary/10 hover:-translate-y-1"
        >
          <div class="mb-4">
            <div
              class="w-12 h-12 rounded-xl bg-gradient-to-br from-primary-500 to-primary-700 flex items-center justify-center"
            >
              <IconChat className="w-6 h-6 text-white" aria-hidden="true" />
            </div>
          </div>
          <h3 class="text-xl font-bold mb-2 group-hover:text-primary transition-colors">
            Channels
          </h3>
          <p class="text-default-700 dark:text-default-500 text-sm mb-4">
            Telegram/WhatsApp/Discord/Slack message and connection issues
          </p>
          <div class="flex items-center text-primary text-sm font-medium">
            <span>View solutions</span>
            <IconChevronRight
              className="w-4 h-4 ml-1 group-hover:translate-x-1 transition-transform"
              aria-hidden="true"
            />
          </div>
        </a>

        <!-- Config -->
        <a
          href="/troubleshooting/solutions?component=config"
          class="group relative overflow-hidden rounded-2xl border border-divider bg-content1 p-6 hover:border-primary/50 transition-all duration-300 hover:shadow-lg hover:shadow-primary/10 hover:-translate-y-1"
        >
          <div class="mb-4">
            <div
              class="w-12 h-12 rounded-xl bg-gradient-to-br from-secondary-500 to-accent-600 flex items-center justify-center"
            >
              <IconCog className="w-6 h-6 text-white" aria-hidden="true" />
            </div>
          </div>
          <h3 class="text-xl font-bold mb-2 group-hover:text-primary transition-colors">
            Configuration
          </h3>
          <p class="text-default-700 dark:text-default-500 text-sm mb-4">
            JSON5/schema validation, wrong types, missing keys
          </p>
          <div class="flex items-center text-primary text-sm font-medium">
            <span>View solutions</span>
            <IconChevronRight
              className="w-4 h-4 ml-1 group-hover:translate-x-1 transition-transform"
              aria-hidden="true"
            />
          </div>
        </a>

        <!-- Models & Auth -->
        <a
          href="/troubleshooting/solutions?component=model"
          class="group relative overflow-hidden rounded-2xl border border-divider bg-content1 p-6 hover:border-primary/50 transition-all duration-300 hover:shadow-lg hover:shadow-primary/10 hover:-translate-y-1"
        >
          <div class="mb-4">
            <div
              class="w-12 h-12 rounded-xl bg-gradient-to-br from-primary-700 to-secondary-600 flex items-center justify-center"
            >
              <IconCodeBracket className="w-6 h-6 text-white" aria-hidden="true" />
            </div>
          </div>
          <h3 class="text-xl font-bold mb-2 group-hover:text-primary transition-colors">
            Models & Auth
          </h3>
          <p class="text-default-700 dark:text-default-500 text-sm mb-4">
            “All models failed”, billing/rate limits, OAuth/setup-token issues
          </p>
          <div class="flex items-center text-primary text-sm font-medium">
            <span>View solutions</span>
            <IconChevronRight
              className="w-4 h-4 ml-1 group-hover:translate-x-1 transition-transform"
              aria-hidden="true"
            />
          </div>
        </a>
      </div>
    </Section>

    <!-- Common Issues -->
    <Section py="py-16">
      <h2 class="text-3xl md:text-4xl font-bold mb-8 text-center">Most Common Issues</h2>
      <div class="max-w-4xl mx-auto space-y-4">
        <!-- Issue 1 -->
        <div
          class="rounded-xl border border-divider bg-content1 p-6 hover:border-primary/30 transition-colors"
        >
          <div class="flex items-start gap-4">
            <div class="flex-shrink-0">
              <div class="w-10 h-10 rounded-lg bg-danger/10 flex items-center justify-center">
                <IconWarning className="w-5 h-5 text-danger" aria-hidden="true" />
              </div>
            </div>
            <div class="flex-1">
              <h3 class="text-lg font-semibold mb-2">Error: Node.js version mismatch</h3>
              <p class="text-default-700 dark:text-default-500 mb-3">
                OpenClaw requires Node.js 22+ (Node 22 LTS recommended). Check your version with <code
                  class="px-2 py-1 rounded bg-content2 text-sm">node --version</code
                >
              </p>
              <a
                href="/troubleshooting/solutions/node-version-mismatch"
                class="text-primary hover:underline text-sm font-medium"
              >
                View solution →
              </a>
            </div>
          </div>
        </div>

        <!-- Issue 2 -->
        <div
          class="rounded-xl border border-divider bg-content1 p-6 hover:border-primary/30 transition-colors"
        >
          <div class="flex items-start gap-4">
            <div class="flex-shrink-0">
              <div class="w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center">
                <IconChat className="w-5 h-5 text-primary" aria-hidden="true" />
              </div>
            </div>
            <div class="flex-1">
              <h3 class="text-lg font-semibold mb-2">Telegram: Bot API requests failing</h3>
              <p class="text-default-700 dark:text-default-500 mb-3">
                Common causes include outbound network/DNS issues to Telegram, or missing token
                configuration.
              </p>
              <a
                href="/troubleshooting/solutions/telegram-setmycommands-failed"
                class="text-primary hover:underline text-sm font-medium"
              >
                View solution →
              </a>
            </div>
          </div>
        </div>

        <!-- Issue 3 -->
        <div
          class="rounded-xl border border-divider bg-content1 p-6 hover:border-primary/30 transition-colors"
        >
          <div class="flex items-start gap-4">
            <div class="flex-shrink-0">
              <div class="w-10 h-10 rounded-lg bg-secondary/10 flex items-center justify-center">
                <IconCodeBracket className="w-5 h-5 text-secondary" aria-hidden="true" />
              </div>
            </div>
            <div class="flex-1">
              <h3 class="text-lg font-semibold mb-2">Invalid JSON syntax in configuration</h3>
              <p class="text-default-700 dark:text-default-500 mb-3">
                JSON parsing errors are often caused by missing commas, trailing commas, or unquoted
                strings.
              </p>
              <a
                href="/troubleshooting/solutions/config-validation-failed"
                class="text-primary hover:underline text-sm font-medium"
              >
                View solution →
              </a>
            </div>
          </div>
        </div>

        <!-- Issue 4 -->
        <div
          class="rounded-xl border border-divider bg-content1 p-6 hover:border-primary/30 transition-colors"
        >
          <div class="flex items-start gap-4">
            <div class="flex-shrink-0">
              <div class="w-10 h-10 rounded-lg bg-danger/10 flex items-center justify-center">
                <IconLockClosed className="w-5 h-5 text-danger" aria-hidden="true" />
              </div>
            </div>
            <div class="flex-1">
              <h3 class="text-lg font-semibold mb-2">
                Permission denied error during installation
              </h3>
              <p class="text-default-700 dark:text-default-500 mb-3">
                This usually occurs when trying to install globally without proper permissions. Use
                sudo or configure npm prefix.
              </p>
              <a
                href="/troubleshooting/solutions/npm-eacces-global-install"
                class="text-primary hover:underline text-sm font-medium"
              >
                View solution →
              </a>
            </div>
          </div>
        </div>

        <!-- Issue 5 -->
        <div
          class="rounded-xl border border-divider bg-content1 p-6 hover:border-primary/30 transition-colors"
        >
          <div class="flex items-start gap-4">
            <div class="flex-shrink-0">
              <div class="w-10 h-10 rounded-lg bg-success/10 flex items-center justify-center">
                <IconDesktop className="w-5 h-5 text-success" aria-hidden="true" />
              </div>
            </div>
            <div class="flex-1">
              <h3 class="text-lg font-semibold mb-2">
                Control UI: disconnected (1008): pairing required
              </h3>
              <p class="text-default-700 dark:text-default-500 mb-3">
                First-time remote connections require one-time device approval. Approve the device,
                then reload.
              </p>
              <a
                href="/troubleshooting/solutions/control-ui-pairing-required"
                class="text-primary hover:underline text-sm font-medium"
              >
                View solution →
              </a>
            </div>
          </div>
        </div>
      </div>
    </Section>

    <!-- Featured Solutions -->
    <Section py="pt-4 pb-20">
      <h2 class="text-3xl md:text-4xl font-bold mb-8 text-center">Featured Solutions</h2>
      <div class="max-w-5xl mx-auto grid md:grid-cols-2 gap-4">
        {
          featuredSolutions.map((c) => (
            <a
              href={c.href}
              class="rounded-xl border border-divider bg-content1 p-6 hover:border-primary/40 transition-colors"
            >
              <h3 class="font-semibold text-foreground mb-2">{c.title}</h3>
              <p class="text-sm text-default-700 dark:text-default-500 line-clamp-2">
                {c.description}
              </p>
              <div class="mt-4 text-sm font-medium text-primary">Read →</div>
            </a>
          ))
        }
      </div>
      <div class="mt-6 text-center text-sm text-default-600">
        Need more? Browse{' '}
        <a class="text-primary hover:underline" href="/troubleshooting/solutions">all solutions</a>{
          ' '
        }
        or ask for help below.
      </div>
    </Section>

    <!-- Community Support Section -->
    <Section py="pt-12 pb-20" containerClass="text-center">
      <h2 class="text-3xl md:text-4xl font-bold mb-6">Still Need Help?</h2>
      <p class="text-default-800 dark:text-default-600 max-w-2xl mx-auto text-lg mb-8">
        Can't find a solution? Our community is here to help you troubleshoot your issue
      </p>
      <div class="flex flex-wrap justify-center gap-4">
        <a
          href="https://forum.coclaw.com"
          target="_blank"
          rel="noopener noreferrer"
          class="inline-flex items-center gap-2 px-6 py-3 rounded-full bg-primary text-primary-foreground hover:bg-primary/90 transition-colors font-semibold"
        >
          <IconChat className="w-5 h-5" aria-hidden="true" />
          Community Forum
        </a>
        <a
          href="https://github.com/openclaw/openclaw/issues"
          target="_blank"
          rel="noopener noreferrer"
          class="inline-flex items-center gap-2 px-6 py-3 rounded-full bg-content1 border border-divider hover:bg-content2 transition-colors font-semibold"
        >
          <IconGithub className="w-5 h-5" aria-hidden="true" />
          GitHub Issues
        </a>
        <a
          href="https://discord.gg/clawd"
          target="_blank"
          rel="noopener noreferrer"
          class="inline-flex items-center gap-2 px-6 py-3 rounded-full bg-content1 border border-divider hover:bg-content2 transition-colors font-semibold"
        >
          <IconDiscord className="w-5 h-5" aria-hidden="true" />
          Discord
        </a>
      </div>
    </Section>
  </div>
</BaseLayout>
