---
import { getCollection } from 'astro:content';
import type { GetStaticPaths } from 'astro';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Section from '../../components/layout/Section.astro';
import { Button, Chip, Avatar } from '@heroui/react';

export const getStaticPaths = (async () => {
  const entries = await getCollection('blog', ({ data }) => !data.draft);
  return entries.map((entry) => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}) satisfies GetStaticPaths;

const { entry } = Astro.props;
const { Content } = await entry.render();

const { title, description, author, publishDate, lastUpdated, category, ogImage, keywords } =
  entry.data;
const image = ogImage || '/images/og/og-main.png';

const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const publishedLabel = publishDate.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'short',
  day: 'numeric',
});
const structuredData = {
  '@context': 'https://schema.org',
  '@type': 'BlogPosting',
  headline: title,
  description,
  image: [new URL(image, Astro.site).toString()],
  author: { '@type': 'Person', name: author },
  publisher: { '@type': 'Organization', name: 'CoClaw', url: 'https://coclaw.com' },
  datePublished: publishDate.toISOString(),
  dateModified: lastUpdated.toISOString(),
  mainEntityOfPage: canonicalURL.toString(),
};
---

<BaseLayout
  title={`${title} | CoClaw Blog`}
  description={description}
  ogImage={image}
  keywords={keywords?.join(', ')}
  type="article"
>
  <script type="application/ld+json" slot="head" set:html={JSON.stringify(structuredData)} />

  <meta slot="head" property="article:published_time" content={publishDate.toISOString()} />
  <meta slot="head" property="article:modified_time" content={lastUpdated.toISOString()} />
  <meta slot="head" property="article:section" content={category} />
  <div class="bg-background min-h-screen relative">
    <!-- Progress Bar (Fixed Top) -->
    <div class="fixed top-0 left-0 w-full h-1 z-50">
      <div id="read-progress" class="h-full bg-primary w-0 transition-all duration-150"></div>
    </div>

    <!-- Hero Header -->
    <header class="relative h-[60vh] min-h-[400px] w-full overflow-hidden">
      <img src={image} alt={title} class="absolute inset-0 w-full h-full object-cover" />
      <div
        class="absolute inset-0 bg-gradient-to-t from-background via-background/40 to-transparent"
      >
      </div>

      <div class="absolute bottom-0 left-0 w-full p-6 md:p-12 lg:p-24">
        <div class="max-w-4xl mx-auto overflow-visible">
          <Chip color="primary" variant="shadow" className="mb-6">{category}</Chip>
          <h1
            class="text-4xl md:text-6xl lg:text-7xl font-black tracking-tighter text-foreground mb-8 line-clamp-3 leading-tight"
          >
            {title}
          </h1>
          <div class="flex items-center gap-6">
            <div class="flex items-center gap-3">
              <Avatar name={author} size="sm" isBordered color="primary" />
              <div>
                <p class="text-foreground font-bold leading-none">{author}</p>
                <p class="text-default-500 text-xs mt-1">OpenClaw Team</p>
              </div>
            </div>
            <div class="h-8 w-px bg-divider"></div>
            <p class="text-default-500 font-medium">{publishedLabel} â€¢ 8 min read</p>
          </div>
        </div>
      </div>
    </header>

    <!-- Content -->
    <Section py="py-20" containerClass="max-w-4xl mx-auto px-6">
      <article class="c-content prose prose-lg prose-primary max-w-none">
        <Content />
      </article>

      <div class="mt-20 pt-12 border-t border-divider">
        <h3 class="text-2xl font-bold mb-8 italic">Shared this insight?</h3>
        <div class="flex gap-4">
          <Button color="primary" radius="full" className="font-bold">Share on X</Button>
          <Button variant="bordered" radius="full" className="font-bold">Copy Link</Button>
        </div>
      </div>
    </Section>
  </div>

  <script is:inline>
    window.addEventListener('scroll', () => {
      const winScroll = document.body.scrollTop || document.documentElement.scrollTop;
      const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
      const scrolled = (winScroll / height) * 100;
      const progress = document.getElementById('read-progress');
      if (progress) progress.style.width = scrolled + '%';
    });
  </script>
</BaseLayout>
