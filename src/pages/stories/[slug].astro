---
import { getCollection } from 'astro:content';
import type { GetStaticPaths } from 'astro';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Section from '../../components/layout/Section.astro';
import RelatedLinks from '../../components/RelatedLinks.astro';
import { buildWeightedTokens, topRelated } from '../../lib/related';
import { Button, Chip, Avatar } from '@heroui/react';

export const getStaticPaths = (async () => {
  const stories = await getCollection('stories', ({ data }) => !data.draft);
  return stories.map((entry) => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}) satisfies GetStaticPaths;

const { entry } = Astro.props;
const { Content } = await entry.render();

const { name, role, company, image, summary, publishDate, sources, keywords } = entry.data;

const allStories = await getCollection('stories', ({ data }) => !data.draft);
const allGuides = await getCollection('guides', ({ data }) => !data.draft);

const seedTokens = buildWeightedTokens([
  { text: name, weight: 3 },
  { text: role, weight: 2 },
  { text: company, weight: 2 },
  { text: summary, weight: 2 },
  { text: keywords ? [keywords] : [], weight: 2 },
]);

const relatedStories = topRelated({
  seed: { id: entry.slug, tokens: seedTokens },
  candidates: allStories.map((s) => ({
    id: s.slug,
    tokens: buildWeightedTokens([
      { text: s.data.name, weight: 3 },
      { text: s.data.role, weight: 2 },
      { text: s.data.company, weight: 2 },
      { text: s.data.summary, weight: 2 },
      { text: s.data.keywords ? [s.data.keywords] : [], weight: 2 },
    ]),
    item: s,
  })),
  limit: 3,
  minScore: 0.08,
}).map(({ item }) => ({
  href: `/stories/${item.slug}`,
  title: item.data.name,
  description: item.data.summary,
  badge: 'Story',
}));

const relatedGuides = topRelated({
  seed: { id: entry.slug, tokens: seedTokens },
  candidates: allGuides.map((g) => ({
    id: g.slug,
    tokens: buildWeightedTokens([
      { text: g.data.title, weight: 3 },
      { text: g.data.description, weight: 2 },
      { text: g.data.keywords ?? [], weight: 2 },
      { text: g.data.category, weight: 1 },
      { text: g.data.platforms ?? [], weight: 1 },
    ]),
    item: g,
  })),
  limit: 2,
}).map(({ item }) => ({
  href: `/guides/${item.slug}`,
  title: item.data.title,
  description: item.data.description,
  badge: 'Guide',
}));

const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const structuredData = {
  '@context': 'https://schema.org',
  '@type': 'Article',
  headline: `${name} — OpenClaw Story`,
  description: summary,
  datePublished: publishDate.toISOString(),
  dateModified: publishDate.toISOString(),
  author: { '@type': 'Organization', name: 'CoClaw' },
  publisher: { '@type': 'Organization', name: 'CoClaw', url: 'https://coclaw.com' },
  mainEntityOfPage: canonicalURL.toString(),
};
---

<BaseLayout
  title={`${name} | CoClaw Stories`}
  description={summary}
  keywords={keywords}
  ogImage={image}
  type="article"
>
  <script type="application/ld+json" slot="head" set:html={JSON.stringify(structuredData)} />
  <div class="bg-background min-h-screen pt-32 pb-24">
    <Section containerClass="max-w-4xl mx-auto px-6">
      <div class="flex flex-col items-center text-center mb-16">
        <Avatar src={image} className="w-24 h-24 mb-6" isBordered color="primary" />
        <div class="flex items-center gap-2 mb-4">
          <Chip size="sm" color="primary" variant="flat" className="font-bold">STORY</Chip>
        </div>
        <h1 class="text-4xl md:text-6xl font-black tracking-tighter mb-4">{name}</h1>
        <p class="text-xl text-default-500 font-medium">{role} @ {company}</p>
        {
          sources?.length ? (
            <p class="mt-6 text-sm text-default-600 max-w-2xl">
              Sources:{' '}
              {sources.map((s, idx) => (
                <>
                  <a
                    href={s.url}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="text-primary hover:underline"
                  >
                    {s.label}
                  </a>
                  {idx < sources.length - 1 ? ' · ' : ''}
                </>
              ))}
            </p>
          ) : null
        }
      </div>

      <article class="c-content prose prose-lg prose-primary max-w-none">
        <Content />
      </article>

      <RelatedLinks title="Related" items={[...relatedStories, ...relatedGuides]} />

      <div
        class="mt-24 p-12 rounded-[40px] bg-gradient-to-br from-primary/10 to-transparent border border-primary/20 text-center"
      >
        <h3 class="text-3xl font-bold mb-6 italic">Ready to write your own story?</h3>
        <p class="text-xl text-default-600 mb-10 max-w-2xl mx-auto">
          Join thousands of users who are building the future of automated, private communication.
        </p>
        <Button
          as="a"
          href="/getting-started"
          size="lg"
          color="primary"
          radius="full"
          className="font-bold px-12 h-16 text-lg"
        >
          Get Started with OpenClaw
        </Button>
      </div>
    </Section>
  </div>
</BaseLayout>
